# 🧠 Telegram-бот с гибридной памятью

Универсальный бот, объединяющий **короткую** и **долгую** память для максимальной эффективности.

## 🎯 Концепция гибридной памяти

### 💭 Короткая память (Short-term)
- **Хранение:** RAM (словарь Python)
- **Размер:** Последние 10 сообщений диалога
- **Назначение:** Контекст разговора, продолжение темы
- **Персистентность:** ❌ Сбрасывается при перезапуске

### 📚 Долгая память (Long-term)
- **Хранение:** ChromaDB (векторная БД)
- **Размер:** Неограниченно документов
- **Назначение:** Знания из документов, факты, справочная информация
- **Персистентность:** ✅ Сохраняется между сеансами

---

## ⚡ Как работает гибридная память

```
┌─────────────────────────────────────────────────────────────┐
│                    ВОПРОС ПОЛЬЗОВАТЕЛЯ                      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
        ┌───────────────────────────────────────┐
        │   Есть документы? (Долгая память)     │
        └───────────────────────────────────────┘
                 │                    │
           ДА    │                    │  НЕТ
                 ▼                    ▼
    ┌─────────────────────┐    ┌──────────────┐
    │ Поиск в ChromaDB    │    │ Пропускаем   │
    │ (semantic search)   │    └──────────────┘
    └─────────────────────┘           │
                 │                    │
                 ▼                    ▼
    ┌─────────────────────────────────────────┐
    │  Формирование контекста для GPT:        │
    │  1. Системный промпт                    │
    │  2. Контекст из документов (если есть)  │
    │  3. История диалога (короткая память)   │
    │  4. Текущий вопрос                      │
    └─────────────────────────────────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │   OpenAI GPT │
                    └──────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │    ОТВЕТ     │
                    └──────────────┘
                            │
                            ▼
    ┌─────────────────────────────────────────┐
    │  Сохранение в короткую память:          │
    │  • Вопрос пользователя                  │
    │  • Ответ бота                           │
    └─────────────────────────────────────────┘
```

---

## 🚀 Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка `.env` файла

```env
BOT_TOKEN=ваш_токен_telegram_бота
OPENAI_API_KEY=ваш_ключ_openai
OPENAI_MODEL=gpt-3.5-turbo
EMBED_MODEL=text-embedding-3-small
```

### 3. Запуск бота

```bash
python bot_hybrid_memory.py
```

---

## 📋 Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Запустить бота и увидеть инструкции |
| `/clear` | Очистить **короткую память** (историю диалога) |
| `/clear_docs` | Очистить **долгую память** (удалить все документы) |
| `/info` | Информация о состоянии **обеих** памятей |

---

## 💡 Примеры использования

### Сценарий 1: Только короткая память (обычный диалог)

```
👤 Вы: Привет! Меня зовут Анна
🤖 Бот: Здравствуй, Анна! Рад познакомиться...

👤 Вы: Как меня зовут?
🤖 Бот: Тебя зовут Анна! [использует короткую память]

👤 Вы: Расскажи про Python
🤖 Бот: Python - это язык программирования...

👤 Вы: А что мы обсуждали до этого?
🤖 Бот: Мы познакомились, ты сказала, что тебя зовут Анна, 
        потом ты спросила как тебя зовут, и я ответил... 
        [использует короткую память]
```

### Сценарий 2: Гибридная память (диалог + документы)

```
👤 Вы: [Загружаете company.txt]
🤖 Бот: ✅ Документ добавлен в долгую память!
        📄 Файл: company.txt
        🧩 Фрагментов: 1

👤 Вы: Какой сайт у компании?
🤖 Бот: Сайт компании SoftLab Technology: http://SoftLab_Technology.ru
        [использует долгую память - документ]

👤 Вы: А какие услуги они предоставляют?
🤖 Бот: SoftLab Technology предоставляет следующие услуги:
        - Разработка AI-агентов
        - Оптимизация БД
        - Интеграция разных модулей в один
        [использует долгую память + короткую память для контекста]

👤 Вы: Спасибо! А про что мы говорили в начале?
🤖 Бот: В начале разговора ты загрузил документ company.txt,
        затем спросил про сайт компании и услуги...
        [использует короткую память]
```

### Сценарий 3: Множественные документы

```
👤 Вы: [Загружаете freedom_bank.txt]
🤖 Бот: ✅ Документ добавлен в долгую память!

👤 Вы: [Загружаете company.txt]
🤖 Бот: ✅ Документ добавлен в долгую память!

👤 Вы: /info
🤖 Бот: 🧠 Состояние гибридной памяти:
        
        💭 КОРОТКАЯ ПАМЯТЬ
        📝 Сообщений в истории: 4/10
        
        📚 ДОЛГАЯ ПАМЯТЬ
        📄 Уникальных файлов: 2
        🧩 Всего фрагментов: 9
        
        Файлы:
        • freedom_bank.txt (8 фрагментов | ⏰ 24.02.2026 23:00)
        • company.txt (1 фрагмент | ⏰ 24.02.2026 23:10)

👤 Вы: Какой БИН у Freedom Bank?
🤖 Бот: БИН Freedom Bank Казахстан: 090 740 019 001
        [ищет в долгой памяти среди всех документов]

👤 Вы: А сайт SoftLab?
🤖 Бот: Сайт SoftLab Technology: http://SoftLab_Technology.ru
        [ищет в долгой памяти, использует другой документ]

👤 Вы: Сравни эти две компании
🤖 Бот: Freedom Bank - это финансовая организация в Казахстане...
        SoftLab Technology - это ИТ-компания...
        [использует ОБЕ памяти: документы + контекст диалога]
```

---

## ⚙️ Настройки

### В файле `bot_hybrid_memory.py`:

```python
# Размер короткой памяти
HISTORY_SIZE = 10  # Количество сообщений

# Параметры долгой памяти
CHUNK_SIZE = 500      # Размер фрагмента документа
CHUNK_OVERLAP = 50    # Перекрытие между фрагментами
```

### В файле `.env`:

```env
# Модель для чата
OPENAI_MODEL=gpt-3.5-turbo
# Альтернативы: gpt-4, gpt-4-turbo, gpt-4o

# Модель для эмбеддингов
EMBED_MODEL=text-embedding-3-small
# Альтернативы: text-embedding-3-large
```

---

## 📊 Сравнение всех трех ботов

| Характеристика | Short Memory | Long Memory | **Hybrid Memory** |
|----------------|--------------|-------------|-------------------|
| **Короткая память** | ✅ | ❌ | ✅ |
| **Долгая память** | ❌ | ✅ | ✅ |
| **Контекст диалога** | ✅ | ❌ | ✅ |
| **Работа с документами** | ❌ | ✅ | ✅ |
| **Персистентность** | ❌ | ✅ | ✅ (частично) |
| **Сложность** | Низкая | Средняя | Средняя |
| **Гибкость** | Низкая | Средняя | **Высокая** |
| **Универсальность** | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 🎯 Когда использовать каждый бот

### `bot_short_memory.py` - Для простых диалогов
- ✅ FAQ-боты
- ✅ Простые чат-боты
- ✅ Поддержка клиентов (базовая)
- ❌ Работа с документами

### `bot_long_memory.py` - Для работы с документами
- ✅ Анализ документов
- ✅ Базы знаний
- ✅ Корпоративные справочники
- ❌ Контекст текущего диалога

### `bot_hybrid_memory.py` - Универсальное решение ⭐
- ✅ Персональные ассистенты
- ✅ Корпоративные боты с документами
- ✅ Обучающие боты
- ✅ Консультанты с экспертизой
- ✅ Все сценарии выше

---

## 🔧 Технические детали

### Архитектура гибридной памяти

```python
# Короткая память (RAM)
user_histories: Dict[int, Deque[dict]] = defaultdict(
    lambda: deque(maxlen=HISTORY_SIZE)
)

# Долгая память (ChromaDB)
collection = chroma_client.get_or_create_collection(
    name="documents",
    metadata={"description": "User uploaded documents"}
)

# Гибридная функция генерации
async def generate_response(user_id, user_message):
    # 1. Ищем в документах (долгая память)
    document_context = await retrieve_context(user_id, user_message)
    
    # 2. Берем историю диалога (короткая память)
    messages.extend(list(user_histories[user_id]))
    
    # 3. Объединяем и отправляем в GPT
    response = await openai_client.chat.completions.create(
        model=OPENAI_MODEL,
        messages=[system, docs, history, current]
    )
    
    # 4. Сохраняем ответ в короткую память
    user_histories[user_id].append({"role": "assistant", ...})
```

### Преимущества гибридного подхода

1. **Контекст диалога** - бот помнит о чем вы говорили
2. **Знания из документов** - точные ответы на основе загруженных файлов
3. **Гибкость** - работает как с документами, так и без них
4. **Персистентность** - документы сохраняются между сеансами
5. **Эффективность** - использует только релевантную информацию

---

## 💰 Примерные затраты OpenAI

### Гибридный режим (документы + диалог)
- **Эмбеддинги:** $0.02 / 1M токенов
- **GPT-3.5-turbo:** $0.50 / 1M токенов
- **Типичный диалог** (50 сообщений + 2 документа): ~$0.10

### Только диалог (без документов)
- Как `bot_short_memory.py`: ~$0.05 на 100 сообщений

---

## 🐛 Устранение неполадок

### Бот не находит информацию в документах

1. Проверьте, что документ загружен: `/info`
2. Убедитесь, что модель эмбеддингов правильная в `.env`
3. Попробуйте переформулировать вопрос

### Бот не помнит контекст диалога

1. Проверьте, что короткая память не переполнена: `/info`
2. Очистите память: `/clear`
3. Убедитесь, что `HISTORY_SIZE` достаточный

### Ошибки модели

Убедитесь в совместимости параметров:
- `gpt-3.5-turbo`, `gpt-4`, `gpt-4o` → используют стандартные параметры
- `gpt-5-mini` → НЕ поддерживает `temperature` (только default=1)

---

## 📚 Структура проекта

```
Bot_with_Memory/
├── bot_short_memory.py       # Только короткая память
├── bot_long_memory.py        # Только долгая память
├── bot_hybrid_memory.py      # ⭐ ГИБРИДНАЯ ПАМЯТЬ
├── requirements.txt          # Зависимости
├── .env                      # Токены и настройки
├── memory/                   # База ChromaDB
└── README_HYBRID.md          # Этот файл
```

---

## 🎓 Рекомендации

### Для начинающих
Начните с `bot_short_memory.py`, затем попробуйте `bot_long_memory.py`, и наконец `bot_hybrid_memory.py`.

### Для production
Используйте `bot_hybrid_memory.py` как основу, добавьте:
- Rate limiting
- Мониторинг затрат
- Backup базы данных
- Логирование в файлы
- Обработку больших документов

---

## 📄 Лицензия

MIT License - используйте свободно!

---

**Создано:** 2026  
**Версия:** 1.0  
**Автор:** AI Assistant

🚀 **Гибридная память = Лучшее из двух миров!** 🧠
